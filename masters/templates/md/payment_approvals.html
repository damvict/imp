{% extends "base.html" %}
{% block title %}Payment Approvals{% endblock %}

{% block content %}
<style>
/* Page */
.page-wrapper {
  background:#F9FAFB;
  min-height:100vh;
  padding:16px;
  animation:fadeIn .3s ease-in;
}

@keyframes fadeIn {
  from { opacity:0; transform:translateY(8px); }
  to { opacity:1; transform:translateY(0); }
}

/* Grid */
.approval-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:18px;
}

/* Card */
.approval-card {
  background:#fff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
  display:flex;
  flex-direction:column;
  transition:transform .2s ease, box-shadow .2s ease;
}

.approval-card:hover {
  transform:translateY(-4px);
  box-shadow:0 12px 28px rgba(37,99,235,.25);
}

/* Header */
.card-header {
  background:linear-gradient(135deg,#5e9be9,#E0F2FE);
  padding:12px 14px;
  border-radius:14px;
  margin:-16px -16px 14px -16px;
}


/* Info rows */
.info-row {
  display:flex;
  justify-content:space-between;
  font-size:13px;
  padding:4px 0;
  border-bottom:1px dashed #E5E7EB;
}
.shipment-code {
  font-size:16px;
  font-weight:800;
  color:#1E3A8A;
}

.info-row:last-of-type {
  border-bottom:none;
}

.info-row span:first-child { color:#6B7280; }
.info-row span:last-child { font-weight:700; color:#111827; }

/* Document link */
.doc-link {
  margin-top:8px;
  font-size:13px;
  font-weight:600;
  color:#2563EB;
  text-decoration:none;
}

.doc-link:hover { text-decoration:underline; }

/* Actions */
.card-actions {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:14px;
}

/* Buttons */
.btn-approve,
.btn-reject {
  width:100%;
  border:none;
  padding:10px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}

.btn-approve {
  background:linear-gradient(135deg,#16A34A,#15803D);
  color:#fff;
}

.btn-reject {
  background:linear-gradient(135deg,#DC2626,#B91C1C);
  color:#fff;
}

/* ================= MODAL ================= */
.modal-overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal-card {
  width:90%;
  max-width:420px;
  background:#fff;
  border-radius:14px;
  padding:16px;
  animation:slideUp .25s ease;
}

@keyframes slideUp {
  from { transform:translateY(20px); opacity:0; }
  to { transform:translateY(0); opacity:1; }
}

.modal-title {
  font-size:18px;
  font-weight:700;
  margin-bottom:10px;
}

.modal-card textarea {
  width:100%;
  border:1px solid #D1D5DB;
  border-radius:10px;
  padding:10px;
  font-size:14px;
  resize:none;
}

.modal-actions {
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:12px;
}

.btn-cancel {
  background:#6B7280;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  font-weight:600;
}
</style>

<div class="page-wrapper">

  <div style="margin-bottom:14px;">
    <a href="{% url 'md_dashboard' %}" class="btn btn-secondary">
      ‚Üê Back to Dashboard
    </a>
  </div>

  <h2 style="color:#1E3A8A;font-weight:800;margin-bottom:16px;">
    Payment Approvals
  </h2>

  {% if shipments %}
    <div class="approval-grid">

      {% for s in shipments %}
      <div class="approval-card">

        <div class="card-header">
          <div class="shipment-code">{{ s.shipment_code }}</div>
        </div>

        <div class="info-row">
          <span>Duty Amount</span>
          <span>Rs {{ s.total_duty_value|floatformat:2 }}</span>
        </div>

        <div class="info-row">
          <span>Supplier</span>
        <span>{{ s.supplier.supplier_name|default:"-" }}</span>

        </div>

        <div class="info-row">
          <span>Bank</span>
          <span>{{ s.duty_paid_bank|default:"-" }}</span>
        </div>

        <div class="info-row">
          <span>Invoice</span>
          <span>{{ s.supplier_invoice }}</span>
        </div>

        <div class="info-row">
          <span>Requested</span>
          <span>{{ s.payment_marked_date|date:"Y-m-d" }}</span>
        </div>

        {% if s.assessment_document %}
          <a href="{{ s.assessment_document.url }}"
             target="_blank"
             class="doc-link">
            üìÑ View Assessment Document
          </a>
        {% endif %}

        <div class="card-actions">

          <!-- APPROVE -->
          <form method="POST" action="{% url 'md-approve-web' s.id %}">
            {% csrf_token %}
            <button type="submit" class="btn-approve">
              Approve
            </button>
          </form>

          <!-- REJECT (MODAL TRIGGER) -->
          <button type="button"
                  class="btn-reject"
                  onclick="openRejectModal({{ s.id }})">
            Reject
          </button>

        </div>

      </div>
      {% endfor %}

    </div>
  {% else %}
    <p>No pending approvals.</p>
  {% endif %}
</div>

<!-- ================= REJECT MODAL ================= -->
<div id="rejectModal" class="modal-overlay">
  <div class="modal-card">

    <h3 class="modal-title">Reason for Rejecting Payment</h3>

    <form method="POST" id="rejectForm">
      {% csrf_token %}

      <textarea
        name="reason"
        id="rejectReason"
        rows="4"
        placeholder="Enter rejection reason *"
        required></textarea>

      <div class="modal-actions">
        <button type="button"
                class="btn-cancel"
                onclick="closeRejectModal()">
          Cancel
        </button>

        <button type="submit"
                class="btn-reject">
          Reject
        </button>
      </div>
    </form>

  </div>
</div>

<script>
function openRejectModal(shipmentId) {
  document.getElementById("rejectReason").value = "";
  document.getElementById("rejectForm").action =
    "{% url 'md-reject-web' 0 %}".replace("/0/", "/" + shipmentId + "/");
  document.getElementById("rejectModal").style.display = "flex";
}

function closeRejectModal() {
  document.getElementById("rejectModal").style.display = "none";
}
</script>

{% endblock %}
