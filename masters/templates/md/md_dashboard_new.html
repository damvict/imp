{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Managing Director Dashboard</title>

<style>
:root {
    --blue: #2563eb;
    --green: #16a34a;
    --orange: #f59e0b;
    --red: #dc2626;
    --purple: #7c3aed;

    --bg: #0a3369;
    --card: #ffffff;
    --text: #1f2937;
    --muted: #6b7280;
    --border: #e5e7eb;
}

* { box-sizing: border-box; }

body {
    margin: 0;
    padding: 16px 24px;
    background: var(--bg);
    font-family: "Inter","Segoe UI",system-ui,sans-serif;
    color: var(--text);
}

h2 {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 8px;
    color: #ffffff;
}

/* ===== MAIN GRID ===== */
.page-grid {
    display: grid;
    grid-template-columns: 3fr 1.2fr;
    gap: 24px;
}

/* ===== LEFT ===== */
.left-column {
    display: flex;
    flex-direction: column;
    gap: 18px;
}

/* ===== KPI ===== */
.shipment-overview {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
}

.kpi-card {
    height: 100px;
    padding: 16px;
    border-radius: 18px;
    color: #ffffff;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.kpi-card span {
    font-size: 11px;
    letter-spacing: .08em;
    opacity: .9;
    margin-bottom: 6px;
}

.kpi-card h3 {
    margin: 0;
    font-size: 28px;
    font-weight: 700;
}

.kpi-blue { background: linear-gradient(135deg,#3b82f6,#2563eb); }
.kpi-green { background: linear-gradient(135deg,#22c55e,#16a34a); }
.kpi-orange { background: linear-gradient(135deg,#fbbf24,#f59e0b); }
.kpi-purple { background: linear-gradient(135deg,#a78bfa,#7c3aed); }
.kpi-red { background: linear-gradient(135deg,#f87171,#dc2626); }

/* ===== TABLE ===== */
.table-wrapper {
    background: var(--card);
    border-radius: 18px;
    border: 1px solid var(--border);
    overflow: hidden;
}

.shipment-table-wrapper {
    max-height: 420px;
    overflow-y: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

th {
    background: #eef3ff;
    color: #1e3a8a;
    padding: 12px;
    font-size: 11px;
    text-transform: uppercase;
}

td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
}

.progress-bar {
    height: 8px;
    background: #e5e7eb;
    border-radius: 10px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg,#22c55e,#16a34a);
}

/* ===== RIGHT / BANKS ===== */
.right-column {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.bank-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 680px;
    overflow-y: auto;
}

.bank-card {
    background: var(--card);
    border-radius: 14px;
    padding: 12px 14px;
    border-left: 4px solid var(--green);
}

.bank-card.danger {
    border-left-color: var(--red);
}

.bank-header {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
}

/* column label row */
.bank-col-labels {
    display: grid;
    grid-template-columns: 40px 1fr 1fr 50px;
    gap: 6px;
    font-size: 10px;
    color: #9ca3af;
    margin-bottom: 2px;
}

.bank-col-labels span {
    text-align: right;
}

.bank-col-labels span:first-child {
    text-align: left;
}

/* data rows */
.bank-line {
    display: grid;
    grid-template-columns: 40px 1fr 1fr 50px;
    gap: 6px;
    align-items: center;
    font-size: 12.5px;
    margin-bottom: 4px;
}

.tag { font-size: 11px; font-weight: 600; color: #2563eb; }
.num { text-align: right; font-weight: 500; }
.muted { color: #6b7280; }

.pct { text-align: right; font-weight: 600; }
.pct.ok { color: #16a34a; }
.pct.warn { color: #f59e0b; }
.pct.danger { color: #dc2626; }

.negative { color: var(--red); font-weight: 600; }
.bank-name {
    font-weight: 700;
    color: #388e84; /* deep blue */
}

.bank-acc {
    font-weight: 500;
    color: #09584b; /* muted gray */
    font-size: 12px;
}

.bank-sep {
    margin: 0 4px;
    color: #9ca3af;
}

</style>
</head>

<body>

<div class="page-grid">

    <!-- LEFT -->
    <div class="left-column">

        <div>
            <h2>Shipment Overview</h2>
            <div class="shipment-overview">
                <div class="kpi-card kpi-blue"><span>ACTIVE</span><h3 id="kpi-active">0</h3></div>
                <div class="kpi-card kpi-green"><span>NEW</span><h3 id="kpi-new">0</h3></div>
                <div class="kpi-card kpi-orange"><span>AT PORT</span><h3 id="kpi-at-port">0</h3></div>
                <div class="kpi-card kpi-purple"><span>ON THE WAY</span><h3 id="kpi-on-way">0</h3></div>
                <div class="kpi-card kpi-red"><span>GRN PENDING</span><h3 id="kpi-grn">0</h3></div>
                <div class="kpi-card kpi-green"><span>COMPLETED</span><h3 id="kpi-completed">0</h3></div>
            </div>
        </div>

        <div>
            <h2>Active Shipments</h2>
            <div class="table-wrapper shipment-table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Shipment</th>
                            <th>Supplier</th>
                            <th>Arrival</th>
                            <th>Phase</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody id="shipment-body"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- RIGHT -->
    <div class="right-column">
        <h2>Bank Facilities</h2>
        <div class="bank-list" id="bank-list"></div>
    </div>

</div>

<script>

    const money = (val) =>
    Number(val || 0).toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });

function refreshDashboard() {
    fetch("{% url 'md_dashboard_data_api' %}")
        .then(res => res.json())
        .then(data => {

            document.getElementById("kpi-active").innerText = data.kpis.total_active;
            document.getElementById("kpi-new").innerText = data.kpis.new;
            document.getElementById("kpi-at-port").innerText = data.kpis.at_port;
            document.getElementById("kpi-on-way").innerText = data.kpis.on_the_way;
            document.getElementById("kpi-grn").innerText = data.kpis.grn;
            document.getElementById("kpi-completed").innerText = data.kpis.completed;

            const tbody = document.getElementById("shipment-body");
            tbody.innerHTML = "";
            data.shipments.forEach(s => {
                tbody.innerHTML += `
                <tr>
                    <td>${s.shipment_code}</td>
                    <td>${s.supplier}</td>
                    <td>${s.arrival}</td>
                    <td>${s.phase}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${s.progress}%"></div>
                        </div>
                    </td>
                </tr>`;
            });

            const bankList = document.getElementById("bank-list");
            bankList.innerHTML = "";
            data.banks.forEach(b => {
                bankList.innerHTML += `
                <div class="bank-card ${b.da_balance < 0 ? 'danger' : ''}">
                   <div class="bank-header">
    <span class="bank-name">${b.bank}</span>
    <span class="bank-sep">â€“</span>
    <span class="bank-acc">${b.accno}</span>
</div>


                    <div class="bank-col-labels">
                        <span></span>
                        <span>Bal</span>
                        <span>Limit</span>
                        <span>%</span>
                    </div>

                    <div class="bank-line">
                        <span class="tag">IMP</span>
                        <span class="num">${money(b.imp_balance)}
</span>
                        <span class="num muted">${money(b.imp_limit)}</span>
                        <span class="pct ok">${b.imp_utilization}%</span>
                    </div>

                    <div class="bank-line">
                        <span class="tag">DA</span>
                        <span class="num ${b.da_balance < 0 ? 'negative' : ''}">
                            ${money(b.da_balance)}
                        </span>
                        <span class="num muted">${money(b.da_limit)}</span>
                        <span class="pct ${b.da_utilization > 80 ? 'warn' : 'ok'}">${b.da_utilization}%</span>
                    </div>
                </div>`;
            });
        });
}

refreshDashboard();
setInterval(refreshDashboard, 30000);

document.addEventListener("click", () => {
    document.documentElement.requestFullscreen();
});
</script>

</body>
</html>
