<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bank Facilities Dashboard</title>

<style>
:root {
    --primary: #0f2a44;
    --success: #2ecc71;
    --warning: #f1c40f;
    --danger: #e74c3c;
    --bg: #f3f6fa;
    --card: #ffffff;
    --muted: #6b778c;
}

body {
    margin: 0;
    padding: 24px;
    background: var(--bg);
    font-family: "Segoe UI", system-ui, sans-serif;
    color: #2c3e50;
}

/* HEADER */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

h1 {
    font-size: 26px;
    font-weight: 600;
    color: var(--primary);
    margin: 0;
}

.last-updated {
    font-size: 12px;
    color: var(--muted);
}

/* BANK GRID */
.bank-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
    gap: 18px;
}

/* BANK TILE */
.bank-section {
    background: var(--card);
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 6px 18px rgba(15,42,68,.07);
}

/* BANK HEADER */
.bank-header {
    font-size: 15px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 10px;
}

/* KPI ROW */
.kpi-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 10px;
}

.kpi-card {
    background: #f9fafb;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px;
    text-align: center;
}

.kpi-title {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: .3px;
    margin-bottom: 4px;
    font-weight: 600;
}

.kpi-value {
    font-size: 15px;
    font-weight: 700;
}

.low { color: var(--success); }
.medium { color: var(--warning); }
.high { color: var(--danger); }

/* TABLE */
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}

th {
    background: #eef3f9;
    padding: 6px;
    text-align: left;
}

td {
    padding: 6px;
    border-bottom: 1px solid #ecf0f1;
}

.right { text-align: right; }
.negative { color: var(--danger); font-weight: 600; }

/* RESPONSIVE */
@media (max-width: 1200px) {
    .bank-grid {
        grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
    }
}
</style>
</head>

<body>

<div class="header">
    <h1>Bank Facilities Dashboard</h1>
    <div class="last-updated">
        Last updated: <span id="lastUpdated">--:--</span>
    </div>
</div>

<div class="bank-grid">

{% for item in dashboard_data %}
<div class="bank-section">

    <div class="bank-header">
        {{ item.bank.b_name }} â€“ {{ item.bank.accno }}
    </div>

    <!-- KPI CARDS -->
    <div class="kpi-row">
        <div class="kpi-card">
            <div class="kpi-title">IMP LIMIT</div>
            <div class="kpi-value"
                 data-bank="{{ item.bank.b_id }}"
                 data-field="imp_limit">
                {{ item.imp_limit|floatformat:2 }}
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-title">IMP USED</div>
            <div class="kpi-value"
                 data-bank="{{ item.bank.b_id }}"
                 data-field="imp_used">
                {{ item.imp_used|floatformat:2 }}
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-title">IMP BAL</div>
            <div class="kpi-value"
                 data-bank="{{ item.bank.b_id }}"
                 data-field="imp_balance">
                {{ item.imp_balance|floatformat:2 }}
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-title">UTIL %</div>
            <div class="kpi-value
                {% if item.imp_utilization < 60 %}
                    low
                {% elif item.imp_utilization < 80 %}
                    medium
                {% else %}
                    high
                {% endif %}
            "
            data-bank="{{ item.bank.b_id }}"
            data-field="utilization">
                {{ item.imp_utilization }}%
            </div>
        </div>
    </div>

    <!-- DA ROW -->
    <table>
        <tbody>
            <tr>
                <td>DA</td>
                <td class="right"
                    data-bank="{{ item.bank.b_id }}"
                    data-field="da_limit">
                    {{ item.da_limit|floatformat:2 }}
                </td>
                <td class="right"
                    data-bank="{{ item.bank.b_id }}"
                    data-field="da_used">
                    {{ item.da_used|floatformat:2 }}
                </td>
                <td class="right {% if item.da_balance < 0 %}negative{% endif %}"
                    data-bank="{{ item.bank.b_id }}"
                    data-field="da_balance">
                    {{ item.da_balance|floatformat:2 }}
                </td>
            </tr>
        </tbody>
    </table>

</div>
{% endfor %}

</div>

<script>
/* ===========================
   CONFIG
   =========================== */

/* TESTING */
const REFRESH_INTERVAL = 30000;

/* PRODUCTION */
// const REFRESH_INTERVAL = 300000;

const DATA_URL = "/bank-dashboard/data/";

/* ===========================
   HELPERS
   =========================== */
function formatNumber(num) {
    return num.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function updateLastUpdated(time) {
    document.getElementById("lastUpdated").textContent = time;
}

/* ===========================
   ZERO-FLICKER REFRESH
   =========================== */
setInterval(() => {
    fetch(DATA_URL)
        .then(res => res.json())
        .then(data => {

            data.banks.forEach(bank => {
                Object.keys(bank).forEach(field => {

                    const el = document.querySelector(
                        `[data-bank="${bank.bank_id}"][data-field="${field}"]`
                    );

                    if (!el) return;

                    if (field === "utilization") {
                        el.textContent = bank[field] + "%";
                        el.classList.remove("low", "medium", "high");

                        if (bank[field] < 60) el.classList.add("low");
                        else if (bank[field] < 80) el.classList.add("medium");
                        else el.classList.add("high");

                    } else if (typeof bank[field] === "number") {
                        el.textContent = formatNumber(bank[field]);

                        if (field === "da_balance") {
                            el.classList.toggle("negative", bank[field] < 0);
                        }
                    }
                });
            });

            updateLastUpdated(data.timestamp);
        })
        .catch(err => console.error("Dashboard refresh failed", err));

}, REFRESH_INTERVAL);
</script>

</body>
</html>
