{% extends "base.html" %}
{% load static %}

{% block title %}Document Handover{% endblock %}

{% block content %}

<style>
/* ================= MODAL ================= */
.custom-modal {
  border-radius: 12px;
  overflow: hidden;
}

.custom-header {
  background: linear-gradient(135deg, #007bff, #0056b3);
  color: #fff;
  border-bottom: none;
}

.agent-list {
  max-height: 300px;
  overflow-y: auto;
}

.agent-list .list-group-item {
  border: none;
  border-radius: 8px;
  margin-bottom: 8px;
  padding: 12px 15px;
  transition: all 0.2s ease;
  cursor: pointer;
  background-color: #f8f9fa;
}

.agent-list .list-group-item:hover {
  background-color: #e9f2ff;
  transform: translateX(4px);
}

.agent-list .list-group-item.active {
  background-color: #007bff;
  color: #fff;
}

.agent-list .list-group-item.active small {
  color: #e0e0e0;
}

.modal-footer {
  border-top: none;
}

#confirmBtn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* ================= PAGE ================= */
body {
  background-color: #f4f6f9;
}

.container-fluid {
  max-width: 1400px;
}

.page-header {
  background: #ffffff;
  border-radius: 12px;
  padding: 20px 25px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.page-header h3 {
  margin: 0;
  font-weight: 600;
}

/* ================= SHIPMENT CARD ================= */
.shipment-card {
  background: #ffffff;
  border-radius: 14px;
  padding: 18px 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.06);
  transition: all 0.25s ease;
  height: 100%;
}

.shipment-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 14px 28px rgba(0,0,0,0.08);
}

.shipment-card h4 {
  font-weight: 700;
  margin-bottom: 6px;
}

.shipment-meta {
  font-size: 13px;
  color: #6c757d;
  margin-bottom: 4px;
}

.shipment-value {
  font-weight: 600;
  color: #28a745;
}

.handover-btn {
  margin-top: 12px;
  border-radius: 30px;
  font-weight: 600;
}

/* ================= EMPTY STATE ================= */
.empty-state {
  background: #ffffff;
  border-radius: 14px;
  padding: 40px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.06);
}
</style>

<div class="container-fluid py-4">

  <!-- PAGE HEADER -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="page-header d-flex justify-content-between align-items-center">
        <h3>Document Handover</h3>
        <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-primary">
          <i class="fa fa-dashboard"></i> Dashboard
        </a>
      </div>
    </div>
  </div>

  <!-- EMPTY STATE -->
  {% if shipments|length == 0 %}
  <div class="text-center mt-5">
    <div class="empty-state">
      <h4 class="text-success mb-2">
        <i class="fa fa-check-circle fa-2x"></i>
      </h4>
      <h4>All Documents Handed Over</h4>
      <p class="text-muted mb-0">No pending shipments available</p>
    </div>
  </div>
  {% endif %}

  <!-- SHIPMENTS -->
  <div class="row">
    {% for s in shipments %}
    <div class="col-md-4 col-sm-6 mb-4">

      <div class="shipment-card">

        <h4 class="text-primary">{{ s.shipment_code }}</h4>

        <p class="shipment-meta">{{ s.supplier.supplier_name }}</p>

        <p class="shipment-meta">
          <strong>BL / AWB:</strong> {{ s.bl }}
        </p>

        <p class="shipment-meta">
          <i class="fa fa-clock-o"></i>
          {{ s.order_date|date:"Y-m-d" }}
        </p>

        <p class="shipment-meta">
          <i class="fa fa-ship"></i>
          Vessel: {{ s.vessel }}
        </p>

        <p class="shipment-value">
          Value: $ {{ s.amount }}
        </p>

        <button
          class="btn btn-primary btn-block handover-btn"
          data-shipment-id="{{ s.id }}">
          <i class="fa fa-share-square"></i>
          Record Handover
        </button>

      </div>

    </div>
    {% endfor %}
  </div>

</div>

<!-- ================= MODAL ================= -->
<div class="modal fade" id="handoverModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content custom-modal">

      <div class="modal-header custom-header">
        <h4 class="modal-title">
          <i class="fa fa-user-circle"></i> Select Clearing Agent
        </h4>
        <button type="button" class="close text-white" data-dismiss="modal">
          &times;
        </button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="selectedShipmentId">
        <div id="agentList" class="list-group agent-list">
          <div class="text-center text-muted py-3">
            <i class="fa fa-spinner fa-spin"></i> Loading agents...
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-light" data-dismiss="modal">Cancel</button>
        <button class="btn btn-success" id="confirmBtn" disabled>
          <i class="fa fa-check"></i> Confirm Handover
        </button>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {

  let selectedAgentId = null;

  $(".handover-btn").on("click", function () {
    $("#selectedShipmentId").val($(this).data("shipment-id"));
    selectedAgentId = null;
    $("#confirmBtn").prop("disabled", true);
    loadAgents();
    $("#handoverModal").modal("show");
  });

  function loadAgents() {
    $("#agentList").html(`<div class="text-center text-muted">Loading agents...</div>`);

    fetch("{% url 'clearing_agent_users_web' %}")
      .then(res => res.json())
      .then(data => {
        $("#agentList").empty();

        if (!data.length) {
          $("#agentList").html(`<div class="text-center text-muted">No agents found</div>`);
          return;
        }

        data.forEach(agent => {
          const item = $(`
            <a href="#" class="list-group-item">
              <strong>${agent.display_name || agent.username}</strong><br>
              <small class="text-muted">${agent.username}</small>
            </a>
          `);

          item.on("click", function (e) {
            e.preventDefault();
            $(".list-group-item").removeClass("active");
            $(this).addClass("active");
            selectedAgentId = agent.id;
            $("#confirmBtn").prop("disabled", false);
          });

          $("#agentList").append(item);
        });
      });
  }

  $("#confirmBtn").on("click", function () {
    fetch(`/shipments/confirm-handover/${$("#selectedShipmentId").val()}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ clearing_agent_id: selectedAgentId })
    })
    .then(() => location.reload());
  });

});
</script>
{% endblock %}
