{% extends "base.html" %}
{% load humanize %}
{% block title %}Shipments{% endblock %}

{% block content %}
<style>
.shipment-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
}

.shipment-card {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

.shipment-code {
  font-size: 16px;
  font-weight: 700;
  color: #1E3A8A;
}

.meta {
  font-size: 13px;
  color: #374151;
  margin-bottom: 4px;
}

.filters {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 6px 14px;
  border-radius: 20px;
  background: #E0E7FF;
  font-weight: 600;
  color: #1E3A8A;
  text-decoration: none;
}

.filter-btn.active {
  background: #1E3A8A;
  color: #fff;
}

/* ===== Phase Badge ===== */
.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  margin-top: 6px;
}

.badge-doc { background:#bfdbfe; color:#1d4ed8; }
.badge-finance { background:#ddd6fe; color:#6d28d9; }
.badge-clearance { background:#fde68a; color:#b45309; }
.badge-complete { background:#bbf7d0; color:#166534; }

.empty-message {
  padding: 40px;
  text-align: center;
  background: #f8fafc;
  border-radius: 12px;
  color: #64748b;
}
</style>

<div class="page-wrapper">

  <h2 class="mb-3">Shipments</h2>

  <!-- FILTER FORM -->
  <form method="get" class="row g-2 mb-4">

    <input type="hidden" name="status" value="{{ status }}">

    <div class="col-md-3">
      <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
    </div>

    <div class="col-md-3">
      <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
    </div>

    <div class="col-md-4">
      <input type="text" name="q"
             value="{{ q }}"
             class="form-control"
             placeholder="Search by BL or Supplier">
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary w-100">Apply</button>
    </div>
  </form>

  <!-- STATUS FILTERS -->
  <div class="filters">
    {% for s in statuses %}
      <a href="?status={{ s }}&q={{ q }}&start_date={{ start_date }}&end_date={{ end_date }}"
         class="filter-btn {% if status == s %}active{% endif %}">
        {{ s }}
      </a>
    {% endfor %}
  </div>

  <!-- ========================= -->
  <!-- DATA DISPLAY SECTION -->
  <!-- ========================= -->

  {% if not filters_applied %}
    <div class="empty-message">
      Please apply filters to view shipments.
    </div>

  {% else %}

    <div class="shipment-grid">
      {% for s in shipments %}
        <div class="shipment-card">

          <div class="shipment-code">
            {{ s.shipment_code }}
          </div>

          <!-- Dynamic Phase Badge -->
          {% if s.current_phase_order <= 3 %}
              <span class="badge badge-doc">
          {% elif s.current_phase_order <= 6 %}
              <span class="badge badge-finance">
          {% elif s.current_phase_order < 13 %}
              <span class="badge badge-clearance">
          {% else %}
              <span class="badge badge-complete">
          {% endif %}
              {{ s.current_phase_name|default:"Not Started" }}
          </span>

          <div class="meta mt-2">
            <strong>Supplier:</strong> {{ s.supplier.supplier_name }}
          </div>

          <div class="meta">
            <strong>BL:</strong> {{ s.bl }}
          </div>

          <div class="meta">
            <strong>Amount:</strong>
            {% if s.currency %}
                {{ s.currency.symbol }} {{ s.amount|floatformat:2|intcomma }}
            {% else %}
                Rs {{ s.amount|floatformat:2|intcomma }}
            {% endif %}
          </div>

          <div class="meta">
            <strong>Order Date:</strong>
            {{ s.order_date|date:"d M Y" }}
          </div>

          <div class="meta">
            <strong>Arrival Date:</strong>
            {{ s.arrival_date|date:"d M Y" }}
          </div>

          <a href="{% url 'shipment-timeline' s.shipment_code %}"
             class="btn btn-sm btn-primary mt-2">
            View Details
          </a>


          <a href="{% url 'modify_shipment' s.id %}"
          class="btn btn-sm btn-warning mt-2 ms-2">
          Edit
        </a>

        </div>
      {% empty %}
        <div class="empty-message">
          No shipments found for selected filters.
        </div>
      {% endfor %}
    </div>

    <!-- PAGINATION -->
    {% if page_obj.paginator.num_pages > 1 %}
    <div class="d-flex justify-content-between align-items-center mt-4">
      {% if page_obj.has_previous %}
        <a class="btn btn-outline-primary btn-sm"
           href="?page={{ page_obj.previous_page_number }}&status={{ status }}&q={{ q }}&start_date={{ start_date }}&end_date={{ end_date }}">
          ← Previous
        </a>
      {% else %}
        <span></span>
      {% endif %}

      <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_next %}
        <a class="btn btn-outline-primary btn-sm"
           href="?page={{ page_obj.next_page_number }}&status={{ status }}&q={{ q }}&start_date={{ start_date }}&end_date={{ end_date }}">
          Next →
        </a>
      {% else %}
        <span></span>
      {% endif %}
    </div>
    {% endif %}

  {% endif %}

</div>
{% endblock %}
